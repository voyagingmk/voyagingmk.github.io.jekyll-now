<!DOCTYPE html>
<html>
  <head>
    <title>redis5.0源码学习笔记（4）分布式相关 – Wyman的原创技术博客 – 恭喜你发现我的小站，撩我请加QQ：234707482、Wechat：_Wyman</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>
    <meta name="baidu-site-verification" content="0OpfO1OtHA" />
    
    <meta name="description" content="Note：本文实际绑定的版本是branch5.0（2018-7-25）。
" />
    <meta property="og:description" content="Note：本文实际绑定的版本是branch5.0（2018-7-25）。
" />
    
    <meta name="author" content="Wyman的原创技术博客" />

    
    <meta property="og:title" content="redis5.0源码学习笔记（4）分布式相关" />
    <meta property="twitter:title" content="redis5.0源码学习笔记（4）分布式相关" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Wyman的原创技术博客 - 恭喜你发现我的小站，撩我请加QQ：234707482、Wechat：_Wyman" href="/feed.xml" />
    
	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-65954265-1', 'auto');
		ga('send', 'pageview', {
		  'page': '/redis-4/',
		  'title': 'redis5.0源码学习笔记（4）分布式相关'
		});
	</script>
	<!-- End Google Analytics -->
	<!-- Baidu Analytics -->
	<script>
		var _hmt = _hmt || [];
		(function() {
		  var hm = document.createElement("script");
		  hm.src = "//hm.baidu.com/hm.js?0dc968591d8c64196a37eca9ca4f86b3";
		  var s = document.getElementsByTagName("script")[0]; 
		  s.parentNode.insertBefore(hm, s);
		})();
	</script>
	<!-- End Baidu Analytics -->

  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="https://www.qiujiawei.com/images/avatar.jpg" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Wyman的原创技术博客</a></h1>
            <p class="site-description">恭喜你发现我的小站，撩我请加QQ：234707482、Wechat：_Wyman</p>
          </div>

          <nav>
            <a href="/">Blog</a>
            <a href="/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <nav class="nav2">
      <ul></ul>
    </nav>

    <div id="main" role="main" class="container">
      <section>  
        <script src="https://code.jquery.com/jquery-3.3.0.min.js" integrity="sha256-RTQy8VOmNlT6b2PIRur37p6JEBZUE7o8wPgMvu18MC4=" crossorigin="anonymous"></script>
<script src="/main.js"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script>
<h1>redis5.0源码学习笔记（4）分布式相关</h1>
 <h3>Tags: <a href="/tag/redis/" rel="tag">redis</a></h3>
<article class="post">
    
    <div class="entry">
        <p>Note：本文实际绑定的版本是branch5.0（2018-7-25）。</p>

<!--more-->

<p>先过一遍cluster的原理和使用方法，再来看代码。</p>

<h2>cluster设计</h2>

<h3>slots</h3>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define CLUSTER_SLOTS 16384
</span></code></pre></div>
<p>redis集群用了槽的概念，总共限定16384个slots。</p>

<p>每个kv的key，用CRC16（hash）然后取模16384，得到槽索引值，就知道对应哪个槽了。</p>

<p>另外还有个节点的概念，节点是指redis集群里单个redis服务器。</p>

<p>节点数量上限是16384，即一个节点一个槽，下限是1。</p>

<p>节点和槽的对应关系：</p>

<p>这个架构下的2个关键点：</p>

<ul>
<li>添加删除节点，槽需要在节点之间移动</li>
<li>槽的移动过程中，服务依然可用</li>
</ul>

<h3>单节点的问题</h3>

<p>因为不同节点存的数据是不一样的，所以单节点故障就会导致那部分数据不可用，实际上，这会导致整个redis集群不可用，因为要保证一致性。</p>

<p>解决方案是单节点要实现主从复制，例如一个主节点可以有一个从节点，这样节点数量会翻一倍。</p>

<h3>集群的主从一致性问题</h3>

<p>redis并不能保证强一致。这是因为使用了异步复制的设计：</p>

<ol>
<li>客户端向某主节点调用会触发write的指令，例如hmset</li>
<li>该主节点立即执行并立即回复客户端执行结果</li>
<li>主节点将写操作复制给它的所有从节点</li>
</ol>

<p>如果2和3调换，就是强一致，但是就会损失可用性（C和A不能同时达到）。</p>

<h2>本机搭建一个集群教程</h2>

<ol>
<li>随便创建一个文件夹如test</li>
<li>在test里面创建6个文件夹：7000、7001、7002、7003、7004、7005</li>
<li>复制redis的redis-server和redis-cli到test文件夹</li>
<li>每个700x子文件夹放一个redis.conf，并启动： ../redis-server ./redis.conf</li>
<li>在test文件夹执行：./redis-cli --cluster create 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 --cluster-replicas 1</li>
</ol>

<p>redis.conf：</p>
<div class="highlight"><pre><code class="language-" data-lang="">port 7002
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 5000
appendonly yes
</code></pre></div>
<p>执行了create指令后，会输出：</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="o">&gt;&gt;&gt;</span> <span class="n">Performing</span> <span class="n">hash</span> <span class="n">slots</span> <span class="n">allocation</span> <span class="n">on</span> <span class="mi">6</span> <span class="n">nodes</span><span class="p">...</span>
<span class="n">Master</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">Slots</span> <span class="mi">0</span> <span class="o">-</span> <span class="mi">5460</span>
<span class="n">Master</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">Slots</span> <span class="mi">5461</span> <span class="o">-</span> <span class="mi">10922</span>
<span class="n">Master</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">Slots</span> <span class="mi">10923</span> <span class="o">-</span> <span class="mi">16383</span>
<span class="n">Adding</span> <span class="n">replica</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7003</span> <span class="n">to</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7000</span>
<span class="n">Adding</span> <span class="n">replica</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7004</span> <span class="n">to</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7001</span>
<span class="n">Adding</span> <span class="n">replica</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7005</span> <span class="n">to</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7002</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">optimize</span> <span class="n">slaves</span> <span class="n">allocation</span> <span class="k">for</span> <span class="n">anti</span><span class="o">-</span><span class="n">affinity</span>
<span class="p">[</span><span class="n">WARNING</span><span class="p">]</span> <span class="n">Some</span> <span class="n">slaves</span> <span class="n">are</span> <span class="n">in</span> <span class="n">the</span> <span class="n">same</span> <span class="n">host</span> <span class="n">as</span> <span class="n">their</span> <span class="n">master</span>
<span class="n">M</span><span class="o">:</span> <span class="mi">10921696574</span><span class="n">cc509be40ae48d704ef6ca67b4171</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7000</span>
   <span class="n">slots</span><span class="o">:</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">5460</span><span class="p">]</span> <span class="p">(</span><span class="mi">5461</span> <span class="n">slots</span><span class="p">)</span> <span class="n">master</span>
<span class="n">M</span><span class="o">:</span> <span class="n">c1f776cd30527cffb9046e01ca30031e1d5bc578</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7001</span>
   <span class="n">slots</span><span class="o">:</span><span class="p">[</span><span class="mi">5461</span><span class="o">-</span><span class="mi">10922</span><span class="p">]</span> <span class="p">(</span><span class="mi">5462</span> <span class="n">slots</span><span class="p">)</span> <span class="n">master</span>
<span class="n">M</span><span class="o">:</span> <span class="mi">77001</span><span class="n">d974c1f5f6db0256622b276293ec36359fb</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7002</span>
   <span class="n">slots</span><span class="o">:</span><span class="p">[</span><span class="mi">10923</span><span class="o">-</span><span class="mi">16383</span><span class="p">]</span> <span class="p">(</span><span class="mi">5461</span> <span class="n">slots</span><span class="p">)</span> <span class="n">master</span>
<span class="n">S</span><span class="o">:</span> <span class="mi">235238</span><span class="n">c0774c50721e8f8f0fad6ca8efb13a6f19</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7003</span>
   <span class="n">replicates</span> <span class="mi">10921696574</span><span class="n">cc509be40ae48d704ef6ca67b4171</span>
<span class="n">S</span><span class="o">:</span> <span class="mi">248661</span><span class="n">b074edd363e91d151391577c4ac0c43bdf</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7004</span>
   <span class="n">replicates</span> <span class="n">c1f776cd30527cffb9046e01ca30031e1d5bc578</span>
<span class="n">S</span><span class="o">:</span> <span class="mi">61199063</span><span class="n">df69d57a096a16ab2c97138f59aeb36d</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7005</span>
   <span class="n">replicates</span> <span class="mi">77001</span><span class="n">d974c1f5f6db0256622b276293ec36359fb</span>
<span class="n">Can</span> <span class="n">I</span> <span class="n">set</span> <span class="n">the</span> <span class="n">above</span> <span class="n">configuration</span><span class="o">?</span> <span class="p">(</span><span class="n">type</span> <span class="err">'</span><span class="n">yes</span><span class="err">'</span> <span class="n">to</span> <span class="n">accept</span><span class="p">)</span><span class="o">:</span>

</code></pre></div>
<p>槽的分配都显示出来了：</p>

<ul>
<li>主节点0，对应槽[0, 5460]</li>
<li>主节点1，对应槽[5461, 10922]</li>
<li>主节点2，对应槽[10923, 16383]</li>
</ul>

<p>主节点是端口分别为7000、7001、7002的节点；7003、7004、7005是相应的从节点。</p>

<p>这里还有个细节：</p>
<div class="highlight"><pre><code class="language-" data-lang="">&gt;&gt;&gt; Trying to optimize slaves allocation for anti-affinity
[WARNING] Some slaves are in the same host as their master
</code></pre></div>
<p>这2行表示redis分析出了这些节点之间组织得并不好，从节点和主节点在同一个主机上。当然现在是测试，忽略它。</p>

<p>键入yes后：</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="p">[</span><span class="n">OK</span><span class="p">]</span> <span class="n">All</span> <span class="n">nodes</span> <span class="n">agree</span> <span class="n">about</span> <span class="n">slots</span> <span class="n">configuration</span><span class="p">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Check</span> <span class="k">for</span> <span class="n">open</span> <span class="n">slots</span><span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Check</span> <span class="n">slots</span> <span class="n">coverage</span><span class="p">...</span>
<span class="p">[</span><span class="n">OK</span><span class="p">]</span> <span class="n">All</span> <span class="mi">16384</span> <span class="n">slots</span> <span class="n">covered</span><span class="p">.</span>
</code></pre></div>
<p>就会把配置告诉所有节点，并且让节点建立起相互通讯，完成集群初始化。</p>

<h2>看下各个节点的输出信息</h2>

<p>7000:</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="mi">9047</span><span class="o">:</span><span class="n">M</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">50</span><span class="p">.</span><span class="mi">634</span> <span class="err">#</span> <span class="n">configEpoch</span> <span class="n">set</span> <span class="n">to</span> <span class="mi">1</span> <span class="n">via</span> <span class="n">CLUSTER</span> <span class="n">SET</span><span class="o">-</span><span class="n">CONFIG</span><span class="o">-</span><span class="n">EPOCH</span>
<span class="mi">69047</span><span class="o">:</span><span class="n">M</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">50</span><span class="p">.</span><span class="mi">679</span> <span class="err">#</span> <span class="n">IP</span> <span class="n">address</span> <span class="k">for</span> <span class="n">this</span> <span class="n">node</span> <span class="n">updated</span> <span class="n">to</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span>
<span class="mi">69047</span><span class="o">:</span><span class="n">M</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">360</span> <span class="o">*</span> <span class="n">Slave</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7003</span> <span class="n">asks</span> <span class="k">for</span> <span class="n">synchronization</span>
<span class="mi">69047</span><span class="o">:</span><span class="n">M</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">360</span> <span class="o">*</span> <span class="n">Partial</span> <span class="n">resynchronization</span> <span class="n">not</span> <span class="n">accepted</span><span class="o">:</span> <span class="n">Replication</span> <span class="n">ID</span> <span class="n">mismatch</span> <span class="p">(</span><span class="n">Slave</span> <span class="n">asked</span> <span class="k">for</span> <span class="err">'</span><span class="mi">33</span><span class="n">f68b0a5ab33163019bb1897036d3b7dd1ac982</span><span class="err">'</span><span class="p">,</span> <span class="n">my</span> <span class="n">replication</span> <span class="n">IDs</span> <span class="n">are</span> <span class="err">'</span><span class="mi">36</span><span class="n">b868ab0e64403a1fae3b9257c799b4cd3a3808</span><span class="err">'</span> <span class="n">and</span> <span class="err">'</span><span class="mo">0000000000000000000000000000000000000000</span><span class="err">'</span><span class="p">)</span>
<span class="mi">69047</span><span class="o">:</span><span class="n">M</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">360</span> <span class="o">*</span> <span class="n">Starting</span> <span class="n">BGSAVE</span> <span class="k">for</span> <span class="n">SYNC</span> <span class="n">with</span> <span class="n">target</span><span class="o">:</span> <span class="n">disk</span>
<span class="mi">69047</span><span class="o">:</span><span class="n">M</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">361</span> <span class="o">*</span> <span class="n">Background</span> <span class="n">saving</span> <span class="n">started</span> <span class="n">by</span> <span class="n">pid</span> <span class="mi">69655</span>
<span class="mi">69655</span><span class="o">:</span><span class="n">C</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">364</span> <span class="o">*</span> <span class="n">DB</span> <span class="n">saved</span> <span class="n">on</span> <span class="n">disk</span>
<span class="mi">69047</span><span class="o">:</span><span class="n">M</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">426</span> <span class="o">*</span> <span class="n">Background</span> <span class="n">saving</span> <span class="n">terminated</span> <span class="n">with</span> <span class="n">success</span>
<span class="mi">69047</span><span class="o">:</span><span class="n">M</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">427</span> <span class="o">*</span> <span class="n">Synchronization</span> <span class="n">with</span> <span class="n">slave</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7003</span> <span class="n">succeeded</span>
<span class="mi">69047</span><span class="o">:</span><span class="n">M</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">633</span> <span class="err">#</span> <span class="n">Cluster</span> <span class="n">state</span> <span class="n">changed</span><span class="o">:</span> <span class="n">ok</span>
</code></pre></div>
<ul>
<li>第三行显示从节点7003开始请求同步数据</li>
<li>第四行显示不能执行部分重同步，因为复制ID不匹配，这是因为这是主从之间的第一次同步</li>
<li>第五行，主节点7000启动了BGSAVE，这是为了把数据同步到硬盘</li>
<li>第六行，提示bg存盘进程启动</li>
<li>第七行，提示数据库已经保存到硬盘上</li>
<li>第八行，提示bg存盘进程成功结束并销毁</li>
<li>第九行，提示和slave的同步也完成了</li>
</ul>

<p>再看下从节点的7003的输出：</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="mi">69054</span><span class="o">:</span><span class="n">M</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">50</span><span class="p">.</span><span class="mi">636</span> <span class="err">#</span> <span class="n">configEpoch</span> <span class="n">set</span> <span class="n">to</span> <span class="mi">4</span> <span class="n">via</span> <span class="n">CLUSTER</span> <span class="n">SET</span><span class="o">-</span><span class="n">CONFIG</span><span class="o">-</span><span class="n">EPOCH</span>
<span class="mi">69054</span><span class="o">:</span><span class="n">M</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">50</span><span class="p">.</span><span class="mi">716</span> <span class="err">#</span> <span class="n">IP</span> <span class="n">address</span> <span class="k">for</span> <span class="n">this</span> <span class="n">node</span> <span class="n">updated</span> <span class="n">to</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span>
<span class="mi">69054</span><span class="o">:</span><span class="n">S</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">54</span><span class="p">.</span><span class="mi">662</span> <span class="o">*</span> <span class="n">Before</span> <span class="n">turning</span> <span class="n">into</span> <span class="n">a</span> <span class="n">slave</span><span class="p">,</span> <span class="n">using</span> <span class="n">my</span> <span class="n">master</span> <span class="n">parameters</span> <span class="n">to</span> <span class="n">synthesize</span> <span class="n">a</span> <span class="n">cached</span> <span class="n">master</span><span class="o">:</span> <span class="n">I</span> <span class="n">may</span> <span class="n">be</span> <span class="n">able</span> <span class="n">to</span> <span class="n">synchronize</span> <span class="n">with</span> <span class="n">the</span> <span class="n">new</span> <span class="n">master</span> <span class="n">with</span> <span class="n">just</span> <span class="n">a</span> <span class="n">partial</span> <span class="n">transfer</span><span class="p">.</span>
<span class="mi">69054</span><span class="o">:</span><span class="n">S</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">54</span><span class="p">.</span><span class="mi">662</span> <span class="err">#</span> <span class="n">Cluster</span> <span class="n">state</span> <span class="n">changed</span><span class="o">:</span> <span class="n">ok</span>
<span class="mi">69054</span><span class="o">:</span><span class="n">S</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">358</span> <span class="o">*</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">MASTER</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7000</span>
<span class="mi">69054</span><span class="o">:</span><span class="n">S</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">359</span> <span class="o">*</span> <span class="n">MASTER</span> <span class="o">&lt;-&gt;</span> <span class="n">SLAVE</span> <span class="n">sync</span> <span class="n">started</span>
<span class="mi">69054</span><span class="o">:</span><span class="n">S</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">359</span> <span class="o">*</span> <span class="n">Non</span> <span class="n">blocking</span> <span class="n">connect</span> <span class="k">for</span> <span class="n">SYNC</span> <span class="n">fired</span> <span class="n">the</span> <span class="n">event</span><span class="p">.</span>
<span class="mi">69054</span><span class="o">:</span><span class="n">S</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">359</span> <span class="o">*</span> <span class="n">Master</span> <span class="n">replied</span> <span class="n">to</span> <span class="n">PING</span><span class="p">,</span> <span class="n">replication</span> <span class="n">can</span> <span class="k">continue</span><span class="p">...</span>
<span class="mi">69054</span><span class="o">:</span><span class="n">S</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">360</span> <span class="o">*</span> <span class="n">Trying</span> <span class="n">a</span> <span class="n">partial</span> <span class="n">resynchronization</span> <span class="p">(</span><span class="n">request</span> <span class="mi">33</span><span class="n">f68b0a5ab33163019bb1897036d3b7dd1ac982</span><span class="o">:</span><span class="mi">1</span><span class="p">).</span>
<span class="mi">69054</span><span class="o">:</span><span class="n">S</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">361</span> <span class="o">*</span> <span class="n">Full</span> <span class="n">resync</span> <span class="n">from</span> <span class="n">master</span><span class="o">:</span> <span class="n">ab929efaa31dd35b6b4a83c7c6c7dd6c75ce157f</span><span class="o">:</span><span class="mi">0</span>
<span class="mi">69054</span><span class="o">:</span><span class="n">S</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">361</span> <span class="o">*</span> <span class="n">Discarding</span> <span class="n">previously</span> <span class="n">cached</span> <span class="n">master</span> <span class="n">state</span><span class="p">.</span>
<span class="mi">69054</span><span class="o">:</span><span class="n">S</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">427</span> <span class="o">*</span> <span class="n">MASTER</span> <span class="o">&lt;-&gt;</span> <span class="n">SLAVE</span> <span class="n">sync</span><span class="o">:</span> <span class="n">receiving</span> <span class="mi">177</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">master</span>
<span class="mi">69054</span><span class="o">:</span><span class="n">S</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">427</span> <span class="o">*</span> <span class="n">MASTER</span> <span class="o">&lt;-&gt;</span> <span class="n">SLAVE</span> <span class="n">sync</span><span class="o">:</span> <span class="n">Flushing</span> <span class="n">old</span> <span class="n">data</span>
<span class="mi">69054</span><span class="o">:</span><span class="n">S</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">427</span> <span class="o">*</span> <span class="n">MASTER</span> <span class="o">&lt;-&gt;</span> <span class="n">SLAVE</span> <span class="n">sync</span><span class="o">:</span> <span class="n">Loading</span> <span class="n">DB</span> <span class="n">in</span> <span class="n">memory</span>
<span class="mi">69054</span><span class="o">:</span><span class="n">S</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">427</span> <span class="o">*</span> <span class="n">MASTER</span> <span class="o">&lt;-&gt;</span> <span class="n">SLAVE</span> <span class="n">sync</span><span class="o">:</span> <span class="n">Finished</span> <span class="n">with</span> <span class="n">success</span>
<span class="mi">69054</span><span class="o">:</span><span class="n">S</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">428</span> <span class="o">*</span> <span class="n">Background</span> <span class="n">append</span> <span class="n">only</span> <span class="n">file</span> <span class="n">rewriting</span> <span class="n">started</span> <span class="n">by</span> <span class="n">pid</span> <span class="mi">69657</span>
<span class="mi">69054</span><span class="o">:</span><span class="n">S</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">453</span> <span class="o">*</span> <span class="n">AOF</span> <span class="n">rewrite</span> <span class="n">child</span> <span class="n">asks</span> <span class="n">to</span> <span class="n">stop</span> <span class="n">sending</span> <span class="n">diffs</span><span class="p">.</span>
<span class="mi">69657</span><span class="o">:</span><span class="n">C</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">453</span> <span class="o">*</span> <span class="n">Parent</span> <span class="n">agreed</span> <span class="n">to</span> <span class="n">stop</span> <span class="n">sending</span> <span class="n">diffs</span><span class="p">.</span> <span class="n">Finalizing</span> <span class="n">AOF</span><span class="p">...</span>
<span class="mi">69657</span><span class="o">:</span><span class="n">C</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">453</span> <span class="o">*</span> <span class="n">Concatenating</span> <span class="mi">0</span><span class="p">.</span><span class="mo">00</span> <span class="n">MB</span> <span class="n">of</span> <span class="n">AOF</span> <span class="n">diff</span> <span class="n">received</span> <span class="n">from</span> <span class="n">parent</span><span class="p">.</span>
<span class="mi">69657</span><span class="o">:</span><span class="n">C</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">453</span> <span class="o">*</span> <span class="n">SYNC</span> <span class="n">append</span> <span class="n">only</span> <span class="n">file</span> <span class="n">rewrite</span> <span class="n">performed</span>
<span class="mi">69054</span><span class="o">:</span><span class="n">S</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">459</span> <span class="o">*</span> <span class="n">Background</span> <span class="n">AOF</span> <span class="n">rewrite</span> <span class="n">terminated</span> <span class="n">with</span> <span class="n">success</span>
<span class="mi">69054</span><span class="o">:</span><span class="n">S</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">459</span> <span class="o">*</span> <span class="n">Residual</span> <span class="n">parent</span> <span class="n">diff</span> <span class="n">successfully</span> <span class="n">flushed</span> <span class="n">to</span> <span class="n">the</span> <span class="n">rewritten</span> <span class="n">AOF</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mo">00</span> <span class="n">MB</span><span class="p">)</span>
<span class="mi">69054</span><span class="o">:</span><span class="n">S</span> <span class="mi">28</span> <span class="n">Jul</span> <span class="mi">13</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">55</span><span class="p">.</span><span class="mi">460</span> <span class="o">*</span> <span class="n">Background</span> <span class="n">AOF</span> <span class="n">rewrite</span> <span class="n">finished</span> <span class="n">successfully</span>
</code></pre></div>
<ul>
<li>从节点因为不能做部分重同步，所以变成完整同步，并清除了旧数据，并载入收到的完整DB数据</li>
<li>从节点还做了AOF文件的处理</li>
</ul>

<h2>测试</h2>

<ul>
<li>启动一个客户端连接到7000节点，并发送一个set指令：</li>
</ul>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="o">/</span><span class="n">redis</span><span class="o">-</span><span class="n">cli</span> <span class="o">-</span><span class="n">c</span> <span class="o">-</span><span class="n">p</span> <span class="mi">7000</span>
<span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7000</span><span class="o">&gt;</span> <span class="n">set</span> <span class="n">foo</span> <span class="n">bar</span>
<span class="o">-&gt;</span> <span class="n">Redirected</span> <span class="n">to</span> <span class="n">slot</span> <span class="p">[</span><span class="mi">12182</span><span class="p">]</span> <span class="n">located</span> <span class="n">at</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7002</span>
<span class="n">OK</span>
<span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7002</span><span class="o">&gt;</span> 
</code></pre></div>
<p>提示这个set指令被重定向到槽12182，即7002节点，根据前面的配置信息，7002是一个主节点。指令返回后，发现终端变成127.0.0.1:7002&gt; ，说明之后的指令都是发往7002主机（也被重定向了）。</p>

<ul>
<li>再发一个set指令：</li>
</ul>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7002</span><span class="o">&gt;</span> <span class="n">set</span> <span class="n">hello</span> <span class="n">world</span>
<span class="o">-&gt;</span> <span class="n">Redirected</span> <span class="n">to</span> <span class="n">slot</span> <span class="p">[</span><span class="mi">866</span><span class="p">]</span> <span class="n">located</span> <span class="n">at</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7000</span>
<span class="n">OK</span>
<span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7000</span><span class="o">&gt;</span> 
</code></pre></div>
<p>现在又回到了7000，hello对应的槽是866。</p>

<ul>
<li>测试读指令，发送一个get：</li>
</ul>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7000</span><span class="o">&gt;</span> <span class="n">get</span> <span class="n">foo</span>
<span class="o">-&gt;</span> <span class="n">Redirected</span> <span class="n">to</span> <span class="n">slot</span> <span class="p">[</span><span class="mi">12182</span><span class="p">]</span> <span class="n">located</span> <span class="n">at</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7002</span>
<span class="s">"bar"</span>
<span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7002</span><span class="o">&gt;</span> 
</code></pre></div>
<p>因为foo是在7002上的，所以又回到了7002，并拿到了刚才写入的&quot;bar&quot;。</p>

<ul>
<li>另外开一个redis-cli来测试下：</li>
</ul>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="p">.</span><span class="o">/</span><span class="n">redis</span><span class="o">-</span><span class="n">cli</span> <span class="o">-</span><span class="n">c</span> <span class="o">-</span><span class="n">p</span> <span class="mi">7001</span>
<span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7001</span><span class="o">&gt;</span> <span class="n">get</span> <span class="n">hello</span>
<span class="o">-&gt;</span> <span class="n">Redirected</span> <span class="n">to</span> <span class="n">slot</span> <span class="p">[</span><span class="mi">866</span><span class="p">]</span> <span class="n">located</span> <span class="n">at</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7000</span>
<span class="s">"world"</span>
<span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7000</span><span class="o">&gt;</span> 
</code></pre></div>
<p>这次连的是另外一台主服务器，被重定向到7000，没什么问题。</p>

<ul>
<li>测试从节点：</li>
</ul>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="p">.</span><span class="o">/</span><span class="n">redis</span><span class="o">-</span><span class="n">cli</span> <span class="o">-</span><span class="n">c</span> <span class="o">-</span><span class="n">p</span> <span class="mi">7005</span>
<span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7005</span><span class="o">&gt;</span> <span class="n">get</span> <span class="n">hello</span>
<span class="o">-&gt;</span> <span class="n">Redirected</span> <span class="n">to</span> <span class="n">slot</span> <span class="p">[</span><span class="mi">866</span><span class="p">]</span> <span class="n">located</span> <span class="n">at</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7000</span>
<span class="s">"world"</span>
<span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7000</span><span class="o">&gt;</span> 
</code></pre></div>
<p>和连接主节点7001的一样，也是重定向到7000，没什么问题。</p>

<ul>
<li>再测试下在从节点执行del指令：</li>
</ul>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="p">.</span><span class="o">/</span><span class="n">redis</span><span class="o">-</span><span class="n">cli</span> <span class="o">-</span><span class="n">c</span> <span class="o">-</span><span class="n">p</span> <span class="mi">7005</span>
<span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7005</span><span class="o">&gt;</span> <span class="n">del</span> <span class="n">hello</span>
<span class="o">-&gt;</span> <span class="n">Redirected</span> <span class="n">to</span> <span class="n">slot</span> <span class="p">[</span><span class="mi">866</span><span class="p">]</span> <span class="n">located</span> <span class="n">at</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7000</span>
<span class="p">(</span><span class="n">integer</span><span class="p">)</span> <span class="mi">1</span>
<span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7000</span><span class="o">&gt;</span> 
</code></pre></div>
<p>和预期的一样，都是先算出槽号并找出对应的目标节点，重定向到目标节点上执行。</p>

<h2>sentinel的基础：raft算法</h2>

<p>脱离sentinel，简单地介绍下raft：</p>

<h3>节点状态</h3>

<p>有且只有三种，任一时刻处于其中之一：</p>

<ul>
<li>Follower</li>
<li>Candidate</li>
<li>Leader</li>
</ul>

<p>初始状态为follower。</p>

<h3>从follower变成candidate</h3>

<p>如果follower节点一段时间内（election timeout，150ms到300ms）都没有收到leader节点的心跳包（heartbeat timeout，不带数据的AppendEntry协议），那么自动把自己升级成candidate节点。</p>

<p>candidate节点做的第一件事是，向其他和自己相连的节点广播一个叫RequestVote的协议，收到该协议的节点会自己做决策，决定是否给这个candidate节点投票，同一个term只能投一次，投票后会重置自己的timer。</p>

<h3>Leader election</h3>

<p>接着，如果一个candidate节点获得了大多数节点的投票（majority of nodes，超过二分之一），那么这个candidate节点升级成leader节点。</p>

<p>leader节点的责任是：所有对raft节点集群的写操作，都要交给leader节点处理。</p>

<h3>log entry和log replication</h3>

<p>每条写操作被称为log entry。</p>

<p>log entry刚被添加到（leader节点的）log列表时，状态是uncommited。意味着这个写操作未产生实际作用。</p>

<p>为了让log entry变成commited状态，leader节点会向其他节点广播AppendEntry协议，然后等待它们的写完成回复，但只需要等其中的大多数节点（majority of nodes)，而不是所有节点。</p>

<p>当确实收到大多数节点的写完成回复时，此时leader节点会把这个log entry改为commited状态，并应用log entry，改变节点的值（数据库状态变更）。还有就是回复客户端。</p>

<p>leader节点还广播告诉其他节点，“这个log entry已经commited了，你们也可以commit它了”。</p>

<p>其他节点都commit这个log entry后，此时集群就达成了一致状态。</p>

<h3>term</h3>

<p>只要leader存在，leader一直能够给其他节点发心跳包，那么term是不会增加的。</p>

<p>换leader才会导致term增加。</p>

<h3>同时获得相同数量投票的问题</h3>

<p>假设有4个节点，其中有2个节点A、B同时变成候选人并同时发出了3个RequestVote：</p>

<ol>
<li>A收到B的RequestVote，B收到A的RequestVote</li>
<li>C收到A的RequestVote，D收到B的RequestVote</li>
<li>B投票给A，A投票给B，A有1票(1/4)，B有1票(1/4)</li>
<li>C投票给A，D投票给B，A有2票(2/4)，B有2票(2/4)</li>
<li>已经没人可以投票了，因为A和B都不能获得大多数节点的投票（起码要3票），于是重新开了一轮选举</li>
<li>此时只要增加时间随机性，就可以使得有一个节点先获得大部分选票，称为leader，结束”死锁状态“</li>
</ol>

<h2>sentinel</h2>

<p>sentinel是用来自动化管理的：</p>

<ul>
<li>监控集群的运行状态</li>
<li>避免人工处理节点故障</li>
<li>主节点故障时，实现新的主节点选举</li>
<li>通知用户发生故障转移，让用户可以去处理故障节点</li>
<li>如果用了sentinel，那么客户端需要先连接sentinel才能知道master节点位置</li>
</ul>

<p>当主节点故障时，要等待一段时间，确认主节点不会恢复时，才开始从节点的选举（故障转移）。</p>

<p>从节点升级到主节点后，如果旧的主节点恢复，那么并不会恢复成主节点，而只是个从节点。</p>

<p>raft算法中的投票方，对应的是sentinel节点集群，而不是redis集群。但master节点、follower节点、log复制，却是redis节点集群之间的。个中区别只能看redis源码来了解。</p>

<h2>资料</h2>

<p><a href="http://www.redis.cn/topics/cluster-tutorial.html">http://www.redis.cn/topics/cluster-tutorial.html</a></p>

    </div>
    <div class="entry">
        (未经授权禁止转载)
    </div>
    <div class="date">
        Written on July 28, 2018
    </div>
    <p>博主将十分感谢对本文章的任意金额的打赏^_^</p>
    <img src="../images/dashang1.jpeg" />
    <img src="../images/dashang2.jpeg" />
    
    
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'qiujiawei';

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</article>



      </section>
    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:voyagingmk@gmail.com"><i class="svg-icon email"></i></a>


<a href="http://github.com/barryclark/jekyll-now"><i class="svg-icon github"></i></a>




<a href="http://twitter.com/voyagingmk"><i class="svg-icon twitter"></i></a>


        </footer>
      </div>
    </div>

  </body>
</html>
