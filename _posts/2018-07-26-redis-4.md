---
layout: post_latex
title: redis5.0源码学习笔记（2）分布式相关
tags: ['redis']
published: true
---

Note：本文实际绑定的版本是branch5.0（2018-7-25）。


<!--more-->


## cluster.h

### slots

```c
#define CLUSTER_SLOTS 16384
```

redis集群用了槽的概念，总共限定16384个slots。

每个kv的key，用CRC16（hash）然后取模16384，得到槽索引值，就知道对应哪个槽了。

另外还有个节点的概念，节点是指redis集群里单个redis服务器。

节点数量上限是16384，即一个节点一个槽，下限是1。

节点和槽的对应关系：

这个架构下的2个关键点：

- 添加删除节点，槽需要在节点之间移动
- 槽的移动过程中，服务依然可用

### 单节点的问题

因为不同节点存的数据是不一样的，所以单节点故障就会导致那部分数据不可用，实际上，这会导致整个redis集群不可用，因为要保证一致性。

解决方案是单节点要实现主从复制，例如一个主节点可以有一个从节点，这样节点数量会翻一倍。



### 集群的主从一致性问题

redis并不能保证强一致。这是因为使用了异步复制的设计：

1. 客户端向某主节点调用会触发write的指令，例如hmset
2. 该主节点立即执行并立即回复客户端执行结果
3. 主节点将写操作复制给它的所有从节点

如果2和3调换，就是强一致，但是就会损失可用性（C和A不能同时达到）。



## 资料

http://www.redis.cn/topics/cluster-tutorial.html