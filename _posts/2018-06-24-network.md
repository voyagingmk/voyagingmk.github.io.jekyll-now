---
layout: post
title: 《计算机网络-自顶向下方法》笔记
tags: ['c++']
published: true
---

<!--more-->


## 网络层

- 是否对ip包分片，取决于输出链路的mtu，如果包大小大于mtu（可能500多到1500字节），那么就会自动分片
- 分片有3个不可或缺字段：ip包的唯一标识（ID)、字节偏移offset、结束标志（0或1，1表示还没结束，0表示当前已是最后一个片）
- 分片是ipv4的机制，且有安全问题，ipv6没有分片，杜绝了安全隐患
- 分片重组是在目的地端主机上进行的，路由器只可能做分片，而不会做重组

- 主机和物理链路之间的边界叫做接口
- 每个接口有自己的ip地址，所以ip地址技术是与接口关联，而不是和主机或路由器
- 子网：直接互联并与其他网络岛隔离的主机接口+路由器接口组成子网
- 子网掩码：例如223.1.1.0/24，/24就是子网掩码

- 网络层有三个主要组件：IP协议、路由选择协议(RIP、OSPF、BGP）、因特网控制报文协议ICMP


查看和修改系统的mtu值：

查看：

ifconfig eth0

修改：

ifconfig eth0 mtu 1460


### DHCP动态主机配置协议

四大步骤：

1. DHCP发现报文，用UDP，端口67，src ip为0.0.0.0，dst ip为255.255.255.255，广播一个发现报文，报文里包含一个事物ID。
2. DHCP提供报文，DHCP服务器收到广播而来的发现报文后，用一个提供报文做响应，src ip为自己的ip，dst ip为255.255.255.255，也是广播。因为DHCP服务器不一定唯一，所以客户机有选择权。提供报文包含，收到的发现报文的事物ID、向客户推荐的IP地址、IP地址的掩码、IP地址租用期（address lease time），租用期一般为几小时到几天。
3. DHCP请求报文，客户机从1到多个提供报文中选择一个，并向该服务器发送DHCP请求报文。
4. DHCP ACK报文，就是第三步的响应报文，告诉客户配置参数。

第四步完成后，客户就可以在租用期里使用这个ip。另外，DHCP也有延长租用期的办法。

### NAT网络地址转换

- NAT是用来解决ipv4的ip地址不够用问题的
- NAT会使得外部主机不能直接访问内网主机（内网主机不可见），因为内网主机没有自己的全球唯一ip地址
- NAT用一张转换表来双向转发数据包
- 内网主机可以主动访问外网，反过来就不行
- NAT的存在对实现p2p应用很不好
- 应用NAT穿越技术，可以改善p2p应用的通讯问题

NAT穿越：https://www.jianshu.com/p/84e8c78ca61d


### ICMP控制报文协议

- 常用于差错报告，例如目的地不可达时，中间路由器就会返回类型3的ICMP报文
- ICMP协议是建立在IP协议上面的，因为是用IP分组承载的。类似TCP、UDP。但一般认为ICMP是属于网络层的协议。
- ICMP报文组成：类型、编码。编码可理解为大类型里的子类型。[wiki](https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol)


ping程序： 发一个ICMP[8,0]报文，目的主机发回一个ICMP[0,0]的报文。

源抑制报文：从wiki可以看到已经deprecated了，最初是用来做拥塞控制的，不过tcp自己有拥塞控制，所以没卵用。

traceroute：原理就是发送一系列IP数据报，每个数据报携带UDP报文，目的地ip为目标主机，端口号设置为不可达的端口号。关键的，第一个数据报的TTL设为1，第二个的TTL为2，以此类推。当第n个数据报到达第n台路由器时，第n台路由器发现这个数据报的TTL正好过期，然后就会发给源主机一个ICMP[11,0]，携带了该路由器的ip地址。然后每个数据报都设置了定时器，收到回复时就可以算出往返延迟RTT。

traceroute还有个问题是何时停止发送udp报文，这是通过ICMP的类型和编码字段判断的，因为如果目的地主机在线，那么最终会返回一个ICMP[3,3]，表示目的主机端口不可达。

