---
layout: post_latex
title: 球谐
published: true
tags: ['sh']
---


<!--more-->

## 三种坐标系

### 球坐标

### 柱坐标

### 矩坐标

## 从radiance map输出irradiance map


### radiance map是什么

其实就是hdr map、enviroment map，一般是一张以某固定点为中心，向四面八方无死角'拍摄'得到的环境图片。

可想而知，这张图图片一般可以用cube map的方式存储，即6张方形图。

为什么又叫hdr map，是因为为了得到pbr效果的话，这张radiance map的亮度范围要允许足够大，如果只是存0-255的亮度的话就不是pbr了，hdr map至少是32位float。

### 鱼眼图

6张方形图虽然好理解，但是不利于计算。于是就有了鱼眼图的存储方式，鱼眼图一般宽度是高度的两倍，往中间切开的话，就有2张1:1的方形图。

### 鱼眼图的坐标系统理解

因为像素有面积，那么可设：

- 每个pixel左下角的坐标为（x，y），则（x=0,y=0）代表图像左下的第一个像素，（x=w-1，y=h-1）代表右上的最后一个像素
- 用（u，v）表示像素的单位化坐标，那么（ u=(x+0.5)/w，v=(y+0.5)/h ）就表示了像素（x,y）的中心点，（ u=0，v=0 ）代表图像左下的第一个像素的左下角，而（ u=(w-1+1)/w，v=(h-1 + 1)/h ），即（u=1，v=1） 表示右上的最后一个像素的右上角

可见uv的取值范围是[0, 1]。我们此时已得到了像素坐标xy转成uv坐标的方法。

再设鱼眼图的横坐标轴为θ，纵坐标是φ（0到π），

我们想要的θ、φ取值需要在指定范围，θ是-π到π，φ是0到π，θ相当于环绕y轴一整个圆圈，φ则相当于绕x轴半个圆圈。这样就覆盖了整个单位球的球面（记住这是3D空间的球）。

θ是-π到π的好处是，能使得鱼眼图是看起来是对称的。左半边的横坐标轴取值范围是-π到0，右半边的范围是0到π，纵轴一样是0到π。


可以用以下公式把uv坐标转成θ、φ球坐标：

```c
		float theta = pi*(uv.x*2.0f - 1.0f);
		float phi = pi*uv.y;
```

有了θ、φ球坐标后，还可以转成3D笛卡尔坐标。

\\[ x = r * cos\\theta sin \\phi \\]

\\[ y = r * sin\\theta sin \\phi \\]

\\[ z = r * cos \\phi \\]

```c
		float x = sin(phi)*sin(theta);
		float y = cos(phi);
		float z = -sin(phi)*cos(theta); // 这里故意对z取反，不影响变换正确性
```

x、y、z做了一些调换。

此时我们就得到了从像素坐标到3D笛卡尔坐标的转换公式，可以预先把这个转换关系烘焙到一个w*h大小的、元素为vector3的二维数组里，称之为directionImage。



### 生成步骤

步骤：

1. 