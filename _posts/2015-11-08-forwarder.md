---
layout: post_latex
title: 开发一个消息转发程序 forwarder
published: false
tags: ['c++']
---

<!--more-->

# 介绍

## 起因：

- 消息转发在我的工作中用处极大，即使认为是造轮子也无妨，因为我可能要针对我的其他实际项目做一些特殊功能
- forwarder功能不复杂、但对性能要求高，不适合用脚本写，需要用c/c++来实现(相比用脚本语言应快得多)
- 比起在业务层加密解密协议包，我觉得更适合在forwarder完成。于是forwarder的需求就又多一项
- forwarder怎么看都是一个可以通用化的东西，适合作为练手开源项目呢(我想不会有人把业务代码放到github吧)


说白了，就是手痒痒要造轮子！


# 大致方案

## 网络拓扑结构

- 客户端(>=1个)和forwarder建立连接;

- 后端(一般是1个)和forwarder建立连接;

![2.png](../images/2015.11/2.png)


## 这是一个库还是一个框架?

理想目标是做成一个框架。但很长一段时间应该是作为一个固定功能的库存在，用户只能拿来用，但不保证能被扩展。


## 消息的流动

- 客户端消息->forwarder->后端处理消息
- 后端消息->forwarder->客户端处理消息

## Pros and Cons

### 优点

forwarder有点nginx的感觉，但这个肯定是非常轻量级(nginx入门不简单，且一般用在web方面)。所以**轻量级**是一个优点。此外，它非常地**高内聚**，即这个库只负责**连接管理**、**消息加解密**、**消息转发**，此外几乎不做其他事情，业务层面的事情应放到后端服务器去完成。有了forwarder之后，对后端开发来说，后端并不需要知道forwarder和客户端是怎么连接、消息是如何加密的，这是一种大大的简化。后端只需要根据forwarder的协议，从forwarder接收来自客户端的消息，以及发消息给forwarder，forwarder会自动转发给客户端。

forwarder作为client和backend之间的一个中间层，对client和backend来说当然是越透明越好。

此外，它的**通用性**、**扩展性**，**可配置性**也是很重要的，但需要在工程方面花功夫。

### 缺点

未实现出来之后不好说缺点。以后再补上。目前很可能的最大的缺点是**扩展性**。

## 用什么网络协议?

其实我的期望是网络传输这部分可以抽象化，即forwarder不限定协议，而由用户指定。

但目前起步阶段也就是试验性阶段，要一步步来。抽象化这个事情，以后再重构下代码即可。

可能会支持的网络传输协议包括：tcp、可靠的udp、http或者基于http的高层次的websocket。

目前打算做tcp和websocket版本。

## 长连接还是短连接?

这方面还欠缺研究，应该是先搞定长连接模式。之后再升级成支持短连接。

如果客户端是移动应用，应该要支持短连接模式，并且要支持消息重发、续发。tcp连接只保证了连接存在的情况下消息的可靠传递，但是对于连接意外断开时的消息处理(类似迅雷的断点续传，发送内容由至少1个或多个连接完成)，tcp是unsolved的，这个问题要自己解决。

## 用什么加密方式？

也是期望可以抽象化。但目前打算贴合实际项目来搞。应该是用对称加密协议。AES之类。


# 代码实现

Notw：这部分会在开发过程中逐步更新。

## 环境

目前打算用modern C++来开发(c++11以上)，网络代码部分可能是纯C，也可能C&C++混着写，anyway。

目标平台当然是*nix(主要是CentOS、Ubuntu、Debian)。若有余力再考虑跨mac和windows。

毕竟是要造轮子，估计不会用高层次的第三方库。(encrypt很可能就要找现成的库了)



# 文档


# 安装



# 代码仓库地址

[https://github.com/voyagingmk/forwarder](https://github.com/voyagingmk/forwarder)









