---
layout: post_latex
title: 漫谈网络通讯加密（3）HKDF
tags: ['crypto']
published: true
---

本文将简单介绍[rfc5869](https://tools.ietf.org/html/rfc5869)提出的HKDF。

<!--more-->

# HKDF = HMAC + KDF

## KDF，密钥导出函数

KDF是加密系统中十分基本和必要的组件。KDF的任务是，**给定某初始密钥材料(IKM，initial keying material)，导出1或多个密码级强度的密钥**。

## HMAC，基于Hash的MAC算法

[wiki](https://en.wikipedia.org/wiki/HMAC)

HMAC是指Hash-based的MAC算法，hash函数是可选的，例如存在这些HMAC实现：

- HMAC_MD5
- HMAC_SHA1
- HMAC_SHA256

虽然hash函数可选，但HMAC是有严格的定义的：

\\[ HMAC(k, m) = H ( (k \oplus opad) || H( (k \oplus ipad) || m) ) \\]

伪代码:

```js
function hmac (key, message)
    opad = [0x5c * blocksize] // Where blocksize is that of the underlying hash function
    ipad = [0x36 * blocksize]

    if (length(key) > blocksize) then
        key = hash(key) // Where 'hash' is the underlying hash function
    end if

    for i from 0 to length(key) - 1
        ipad[i] = ipad[i] XOR key[i]
        opad[i] = opad[i] XOR key[i]
    end for

    return hash(opad || hash(ipad || message)) // Where || is concatenation
end function

```

代码逻辑和上面的公式是一致的，一共调用了2次hash函数，2次异或操作，2次concat操作。

唯一特别的是多了一个if的判断：如果key的长度比要求的blocksize还长，那么需要缩短，方法是用hash函数hash一下这个key，从而变成blocksize长度。

HMAC的图解如下(from wiki)：

![1.png](../images/2018.7/8.png)


## extract-then-expand





